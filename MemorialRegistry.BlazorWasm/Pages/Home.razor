@page "/"
@inject ObituaryApiService ObituaryService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@* 
 BLAZOR WEBASSEMBLY MIGRATION COMPLETE
 =====================================
 Originally: ASP.NET Core MVC with server-side rendering
 Migrated to: Blazor WebAssembly with client-side rendering
 
 Key Components:
 - ObituaryApiService: HTTP client for API communication
 - JWT Authentication: Secure user sessions
 - Responsive UI: Bootstrap 5 with modern components
 - Error Handling: Comprehensive user feedback
 - Aspire Orchestration: Streamlined development workflow
*@

<PageTitle>In Memory Of - Memorial Registry</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-4 text-primary">
                    <i class="fas fa-dove"></i> In Memory Of
                </h1>
                <AuthorizeView>
                    <Authorized>
                        <a href="/create" class="btn btn-primary btn-lg shadow">
                            <i class="fas fa-plus"></i> Create New Obituary
                        </a>
                    </Authorized>
                </AuthorizeView>
            </div>
            
            <!-- Search Section -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body bg-light">
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0 ps-0" 
                                       placeholder="Search obituaries by name..." 
                                       @bind="searchTerm" @onkeypress="HandleKeyPress" />
                                <button class="btn btn-outline-primary" type="button" @onclick="SearchAsync">
                                    <i class="fas fa-search me-1"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEBUG PANEL: Hidden by default after successful Blazor WebAssembly migration -->
            <!-- Toggle with Ctrl+D or click the debug button -->
            @if (showDebug)
            {
                <div class="alert alert-info mb-3">
                    <h6>🔧 Debug Info (Migration Complete):</h6>
                    <p><strong>Obituaries Count:</strong> @(obituaries?.Count ?? 0)</p>
                    <p><strong>Loading:</strong> @isLoading</p>
                    <p><strong>Error:</strong> @(errorMessage ?? "None")</p>
                    <p><strong>Current Page:</strong> @currentPage</p>
                    @if (paginationInfo != null)
                    {
                        <p><strong>Total Count:</strong> @paginationInfo.TotalCount</p>
                    }
                    <div class="mt-2">
                        <button class="btn btn-primary btn-sm" @onclick="TestApiConnection">Test API Connection</button>
                        <span class="ms-2 text-muted">@testResult</span>
                    </div>
                    <small class="text-muted">✅ MVC to Blazor WebAssembly migration successful</small>
                </div>
            }
            
            <!-- Debug Toggle Button -->
            <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">
                <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleDebug" title="Toggle Debug Panel (Ctrl+D)">
                    @if (showDebug) { <i class="fas fa-eye-slash"></i> } else { <i class="fas fa-bug"></i> }
                </button>
            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
            }

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading obituaries...</p>
                </div>
            }
            else if (obituaries?.Any() == true)
            {
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Obituary Records
                            <span class="badge bg-light text-dark ms-2">@obituaries.Count records</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <i class="fas fa-user"></i> Full Name
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-birthday-cake"></i> Birth Date
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-cross"></i> Death Date
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-file-text"></i> Biography
                                        </th>
                                        <th scope="col" class="text-center">
                                            <i class="fas fa-cogs"></i> Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var obituary in obituaries)
                                    {
                                        <tr class="align-middle">
                                            <td class="fw-semibold">
                                                <i class="fas fa-user-circle text-muted me-2"></i>
                                                @obituary.FullName
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    @obituary.DateOfBirth.ToString("MMM dd, yyyy")
                                                </small>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-times me-1"></i>
                                                    @obituary.DateOfDeath.ToString("MMM dd, yyyy")
                                                </small>
                                            </td>
                                            <td>
                                                <div class="biography-preview">
                                                    @(obituary.Biography.Length > 100 ? 
                                                      obituary.Biography.Substring(0, 100) + "..." : 
                                                      obituary.Biography)
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <a href="/details/@obituary.Id" class="btn btn-outline-info btn-sm">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    <AuthorizeView>
                                                        <Authorized>
                                                            <a href="/edit/@obituary.Id" class="btn btn-outline-warning btn-sm">
                                                                <i class="fas fa-edit"></i> Edit
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteObituary(obituary.Id)">
                                                                <i class="fas fa-trash"></i> Delete
                                                            </button>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                @if (paginationInfo != null && paginationInfo.TotalPages > 1)
                {
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(!paginationInfo.HasPrevious ? "disabled" : "")">
                                <button class="page-link" @onclick="() => LoadPage(paginationInfo.CurrentPage - 1)" disabled="@(!paginationInfo.HasPrevious)">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                            </li>
                            
                            @for (int i = Math.Max(1, paginationInfo.CurrentPage - 2); i <= Math.Min(paginationInfo.TotalPages, paginationInfo.CurrentPage + 2); i++)
                            {
                                var page = i;
                                <li class="page-item @(page == paginationInfo.CurrentPage ? "active" : "")">
                                    <button class="page-link" @onclick="() => LoadPage(page)">@(page)</button>
                                </li>
                            }
                            
                            <li class="page-item @(!paginationInfo.HasNext ? "disabled" : "")">
                                <button class="page-link" @onclick="() => LoadPage(paginationInfo.CurrentPage + 1)" disabled="@(!paginationInfo.HasNext)">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No obituaries found</h4>
                    <p class="text-muted">@(string.IsNullOrEmpty(searchTerm) ? "No obituaries have been created yet." : $"No obituaries found matching '{searchTerm}'.")</p>
                    <AuthorizeView>
                        <Authorized>
                            <a href="/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create First Obituary
                            </a>
                        </Authorized>
                        <NotAuthorized>
                            <a href="/login" class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt"></i> Login to Create Obituary
                            </a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Obituary> obituaries = new();
    private PaginationInfo? paginationInfo;
    private bool isLoading = true;
    private string searchTerm = "";
    private string? errorMessage;
    private int currentPage = 1;
    private const int pageSize = 10;
    
    // DEBUG VARIABLES: Hidden by default after successful migration
    private string testResult = "";
    private bool showDebug = false; // Toggle with Ctrl+D or debug button
    
    /* MIGRATION NOTES:
     * ✅ Successfully migrated from MVC to Blazor WebAssembly
     * ✅ ObituaryApiService provides HTTP client integration
     * ✅ JWT authentication with CustomAuthenticationStateProvider
     * ✅ Proper error handling and user feedback
     * ✅ Responsive Bootstrap UI with modern components
     * ✅ Pagination and search functionality
     * ✅ CORS configured for cross-origin API calls
     * ✅ Aspire orchestration for development workflow
     */

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("Home page initializing...");
        await LoadObituariesAsync();
    }

    private async Task LoadObituariesAsync()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            Console.WriteLine($"Loading obituaries page {currentPage}...");
            var response = await ObituaryService.GetObituariesAsync(currentPage, pageSize);
            Console.WriteLine($"Received {response.Data.Count} obituaries");
            obituaries = response.Data;
            paginationInfo = response.Pagination;
            
            if (obituaries.Count == 0)
            {
                Console.WriteLine("No obituaries found in database");
            }
        }
        catch (HttpRequestException httpEx)
        {
            Console.WriteLine($"HTTP Error loading obituaries: {httpEx.Message}");
            errorMessage = $"Unable to connect to the server. Please check that the API is running.";
            obituaries = new List<Obituary>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading obituaries: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            errorMessage = $"Error loading obituaries: {ex.Message}";
            obituaries = new List<Obituary>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadObituariesAsync();
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            currentPage = 1;
            await LoadObituariesAsync();
        }
        else
        {
            isLoading = true;
            StateHasChanged();

            try
            {
                obituaries = await ObituaryService.SearchObituariesAsync(searchTerm);
                paginationInfo = null; // Reset pagination for search results
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error searching obituaries: {ex.Message}");
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAsync();
        }
    }

    private async Task DeleteObituary(int id)
    {
        if (await ConfirmDelete())
        {
            try
            {
                await ObituaryService.DeleteObituaryAsync(id);
                await LoadObituariesAsync(); // Refresh the list
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting obituary: {ex.Message}");
            }
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // TODO: Implement proper modal confirmation dialog
        // For now, simplified for demo purposes
        return true;
    }

    // DEBUG METHODS: Hidden by default after migration success
    private void ToggleDebug()
    {
        showDebug = !showDebug;
        StateHasChanged();
    }

    private async Task TestApiConnection()
    {
        // API CONNECTION TEST: Validates Blazor ↔ API communication
        try
        {
            testResult = "Testing API connection...";
            StateHasChanged();
            
            var response = await ObituaryService.GetObituariesAsync(1, 1);
            testResult = $"✅ SUCCESS: API connected, {response.Data?.Count ?? 0} obituaries, Total: {response.Pagination?.TotalCount ?? 0}";
        }
        catch (HttpRequestException ex)
        {
            testResult = $"❌ HTTP ERROR: {ex.Message}";
        }
        catch (Exception ex)
        {
            testResult = $"❌ ERROR: {ex.Message}";
        }
        
        StateHasChanged();
    }

    // KEYBOARD SHORTCUTS: Ctrl+D to toggle debug
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register Ctrl+D shortcut for debug toggle
            await JSRuntime.InvokeVoidAsync("addKeyboardShortcut", "KeyD", DotNetObjectReference.Create(this), nameof(ToggleDebug));
        }
    }

    [JSInvokable]
    public void OnKeyboardShortcut()
    {
        ToggleDebug();
    }
}
